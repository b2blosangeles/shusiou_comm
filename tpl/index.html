<!DOCTYPE html>
<html>
<head>
    <title>速修语言加密通信{$room}</title>
	<meta charset="utf-8" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/annyang/2.6.1/annyang.min.js"></script>	
	<script>
	if (annyang) {
	  // Let's define our first command. First the text we expect, and then the function it should call
	  var commands = {
	    'good': function() {
	      alert('good job');
	    }
	  };

	  // Add our commands to annyang
	  annyang.addCommands(commands);

	  // Start listening. You can call this here, or attach this call to an event, button, etc.
	  annyang.start();
	}
	</script>	
	<script>	
		
			onServerData : function(incomeData, socket) {
				if (incomeData.data._code === 'qnaRequest') {
					socket.emit('clientData', {_socket: incomeData.data._sender, _link: incomeData._link, 
						_proxy: _proxy, 
						data: {connection: [socket.id, incomeData.data._sender], _code : 'resQnaRequest',
						      ping_id : incomeData.data.ping_id
						      }});	
				}
			},
		let _dns = {"comm":["https://comm1.service.dev.shusiou.win/"]}, roomName = '{$room}', comm_area = {};
		let _socket = '{$socket}'
		let _proxy = ['http://comm1.service.dev.shusiou.win/', 'https://comm1.service.dev.shusiou.win/'];
		
		let qna = {ping_id:{}};
		
		qna.server = function(incomeData) {
			me.socket.emit('clientData', {_socket: incomeData.data._sender, _link: incomeData._link, 
				_proxy: _proxy, 
				data: {connection: [socket.id, incomeData.data._sender], _code : 'resQnaRequest',
				      ping_id : incomeData.data.ping_id
				      }});			
		}
		qna.client = function(incomeData) {			
		}		
		qna.init = function() {
			let me = this;
			me.socket = io.connect(_dns.comm[0]);
			me.socket.on('connect', function() {
				me.socket.on('serverData', function(incomeData) {
					if (incomeData.data._code === 'clientRequest') {
						me.server(incomeData);
					} else {
						// if (incomeData.data.connection.indexOf(me.socket.id) !== -1) {
							delete me.ping_id[incomeData.data.ping_id];
						// }
					}
				});
				setInterval(function() {
					let ping_id = new Date().getTime();
					me.ping_id[ping_id] = 1;
					me.socket.emit('clientData', {_socket: _socket, _link: _dns.comm[0], _proxy: _proxy, 
					data: {_sender: me.socket.id, _code : 'qnaRequest', ping_id: ping_id}});
					me.audit();

				}, 500);
			});			
		};
		qna.audit = function() {
			let me = this;
			document.getElementById('income_info').innerHTML = 
						JSON.stringify(me.ping_id);
			window.focus();
			for (var k in me.ping_id) {
				if ((new Date().getTime() - k) > 3000) {
					me.closeme();
					window.close();
				}
			};
		};
		qna.closeme = function() {
			let me = this;
			me.socket.close();
			
		};		
		qna.init();
	</script>
</head>
<body>
	速修语言加密通信
	<div id="income_info"></div>
</body>
</html>
